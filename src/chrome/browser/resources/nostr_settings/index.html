<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Nostr Settings</title>
  <link rel="stylesheet" href="chrome://resources/css/chrome_shared.css">
  <link rel="stylesheet" href="nostr_settings.css">
  <script src="chrome://resources/js/cr.js"></script>
  <script src="chrome://resources/js/promise_resolver.js"></script>
  <script src="chrome://resources/js/util.js"></script>
  <script src="account_manager.js"></script>
  <script src="permission_manager.js"></script>
  <script src="nostr_settings.js"></script>
</head>
<body>
  <div class="settings-container">
    <h1>Nostr Settings</h1>
    
    <nav class="settings-nav">
      <button class="nav-button" data-section="accounts">Accounts</button>
      <button class="nav-button" data-section="permissions">Permissions</button>
      <button class="nav-button" data-section="local-relay">Local Relay</button>
      <button class="nav-button" data-section="blossom">Blossom Storage</button>
      <button class="nav-button" data-section="security">Security</button>
    </nav>
    
    <div class="settings-content">
      <!-- Accounts Section -->
      <section id="accounts" class="settings-section">
        <h2>Nostr Accounts</h2>
        <div class="section-content">
          <div class="setting-item">
            <p>Manage your Nostr identities and switch between accounts</p>
            
            <!-- Current Account Display -->
            <div id="current-account" class="current-account-display" hidden>
              <h3>Active Account</h3>
              <div class="current-account-info">
                <div class="account-avatar">
                  <img id="current-account-avatar" src="" alt="Avatar">
                  <div class="avatar-placeholder" id="current-account-placeholder">N</div>
                </div>
                <div class="account-details">
                  <div id="current-account-name" class="account-name"></div>
                  <div id="current-account-pubkey" class="account-pubkey"></div>
                  <div id="current-account-nip05" class="account-nip05"></div>
                </div>
              </div>
            </div>
            
            <!-- Accounts List -->
            <h3>All Accounts</h3>
            <div id="accounts-list" class="accounts-list"></div>
            
            <!-- Account Actions -->
            <div class="account-actions-container">
              <button id="add-account-button" class="primary-button">
                <span class="icon">+</span> Create New Account
              </button>
              <button id="import-account-button" class="secondary-button">
                <span class="icon">⬇</span> Import Account
              </button>
            </div>
          </div>
        </div>
      </section>
      
      <!-- Account Creation Wizard -->
      <dialog id="account-creation-dialog" class="account-dialog">
        <div class="dialog-header">
          <h2>Create New Account</h2>
          <button class="close-button" id="close-creation-dialog">×</button>
        </div>
        <div class="wizard-steps">
          <div class="step active" data-step="1">1. Generate Keys</div>
          <div class="step" data-step="2">2. Profile Setup</div>
          <div class="step" data-step="3">3. Backup Keys</div>
        </div>
        <div class="dialog-content">
          <!-- Step 1: Key Generation -->
          <div id="step-1" class="wizard-step active">
            <h3>Generate Your Nostr Keys</h3>
            <p>Your keys are your identity on Nostr. Keep them safe!</p>
            <div class="key-display">
              <div class="key-field">
                <label>Public Key (npub)</label>
                <div class="key-value" id="generated-npub"></div>
                <button class="copy-button" data-copy="generated-npub">Copy</button>
              </div>
              <div class="key-field">
                <label>Private Key (nsec) - Keep this secret!</label>
                <div class="key-value masked" id="generated-nsec">
                  <span class="masked-content">••••••••••••••••••••</span>
                </div>
                <button class="toggle-visibility" data-target="generated-nsec">Show</button>
                <button class="copy-button" data-copy="generated-nsec">Copy</button>
              </div>
            </div>
            <div class="warning-box">
              <strong>⚠️ Important:</strong> Save your private key somewhere safe. 
              If you lose it, you cannot recover your account!
            </div>
          </div>
          
          <!-- Step 2: Profile Setup -->
          <div id="step-2" class="wizard-step" hidden>
            <h3>Set Up Your Profile</h3>
            <div class="form-group">
              <label for="account-name">Display Name</label>
              <input type="text" id="account-name" placeholder="Enter your display name">
            </div>
            <div class="form-group">
              <label for="account-about">About</label>
              <textarea id="account-about" rows="3" placeholder="Tell something about yourself"></textarea>
            </div>
            <div class="form-group">
              <label for="account-picture">Picture URL (optional)</label>
              <input type="url" id="account-picture" placeholder="https://example.com/avatar.jpg">
            </div>
            <div class="form-group">
              <label for="account-nip05">NIP-05 Identifier (optional)</label>
              <input type="text" id="account-nip05" placeholder="name@example.com">
            </div>
          </div>
          
          <!-- Step 3: Backup -->
          <div id="step-3" class="wizard-step" hidden>
            <h3>Backup Your Keys</h3>
            <p>Choose how you want to backup your keys:</p>
            <div class="backup-options">
              <label class="backup-option">
                <input type="checkbox" id="backup-downloaded">
                <span>Download encrypted backup file</span>
              </label>
              <label class="backup-option">
                <input type="checkbox" id="backup-written">
                <span>I have written down my private key</span>
              </label>
              <label class="backup-option">
                <input type="checkbox" id="backup-password-manager">
                <span>I have saved it in my password manager</span>
              </label>
            </div>
            <div class="qr-code-container" hidden>
              <h4>QR Code (Private Key)</h4>
              <canvas id="nsec-qr-code"></canvas>
            </div>
          </div>
        </div>
        <div class="dialog-footer">
          <button id="wizard-back" class="secondary-button" hidden>Back</button>
          <button id="wizard-next" class="primary-button">Next</button>
          <button id="wizard-finish" class="primary-button" hidden>Create Account</button>
        </div>
      </dialog>
      
      <!-- Import Account Dialog -->
      <dialog id="import-account-dialog" class="account-dialog">
        <div class="dialog-header">
          <h2>Import Account</h2>
          <button class="close-button" id="close-import-dialog">×</button>
        </div>
        <div class="dialog-content">
          <p>Import an existing Nostr account using your private key</p>
          <div class="import-tabs">
            <button class="tab-button active" data-tab="text">Text</button>
            <button class="tab-button" data-tab="file">File</button>
            <button class="tab-button" data-tab="qr">QR Code</button>
          </div>
          
          <!-- Text Import -->
          <div id="import-text" class="import-panel active">
            <div class="form-group">
              <label for="import-nsec">Private Key (nsec or hex)</label>
              <input type="password" id="import-nsec" placeholder="nsec1..." autocomplete="off">
              <button class="toggle-visibility" data-target="import-nsec">Show</button>
            </div>
          </div>
          
          <!-- File Import -->
          <div id="import-file" class="import-panel" hidden>
            <div class="form-group">
              <label for="import-file-input">Select backup file</label>
              <input type="file" id="import-file-input" accept=".json,.txt">
              <p class="help-text">Supports encrypted backup files from Tungsten or other Nostr clients</p>
            </div>
            <div class="form-group" id="file-password-group" hidden>
              <label for="import-file-password">File Password</label>
              <input type="password" id="import-file-password" placeholder="Enter password">
            </div>
          </div>
          
          <!-- QR Import -->
          <div id="import-qr" class="import-panel" hidden>
            <div class="qr-scanner">
              <video id="qr-video" hidden></video>
              <canvas id="qr-canvas"></canvas>
              <button id="start-qr-scan" class="primary-button">Start Camera</button>
            </div>
          </div>
          
          <div class="warning-box">
            <strong>Security Note:</strong> Your private key will be encrypted and stored securely in your browser.
          </div>
        </div>
        <div class="dialog-footer">
          <button id="cancel-import" class="secondary-button">Cancel</button>
          <button id="confirm-import" class="primary-button">Import Account</button>
        </div>
      </dialog>
      
      <!-- Account Switch Dialog -->
      <dialog id="switch-account-dialog" class="account-dialog compact">
        <div class="dialog-header">
          <h3>Switch Account</h3>
          <button class="close-button" id="close-switch-dialog">×</button>
        </div>
        <div class="dialog-content">
          <div id="switch-accounts-list" class="switch-accounts-list"></div>
        </div>
      </dialog>
      
      <!-- Permissions Section -->
      <section id="permissions" class="settings-section" hidden>
        <h2>Site Permissions</h2>
        <div class="section-content">
          <div class="setting-item">
            <p>Control which sites can access your Nostr identity and operations</p>
            
            <!-- Permission Controls -->
            <div class="permission-controls-bar">
              <div class="permission-search">
                <input type="text" id="permission-search" placeholder="Search sites..." class="search-input">
              </div>
              <div class="permission-actions">
                <button id="bulk-permissions-button" class="secondary-button">Bulk Actions</button>
                <button id="add-permission-button" class="secondary-button">Add Site</button>
                <button id="clear-all-permissions" class="danger-button">Clear All</button>
              </div>
            </div>
            
            <!-- Permission Summary -->
            <div class="permission-summary">
              <div class="permission-stat">
                <span class="stat-number" id="total-sites">0</span>
                <span class="stat-label">Sites</span>
              </div>
              <div class="permission-stat">
                <span class="stat-number" id="allowed-sites">0</span>
                <span class="stat-label">Allowed</span>
              </div>
              <div class="permission-stat">
                <span class="stat-number" id="blocked-sites">0</span>
                <span class="stat-label">Blocked</span>
              </div>
              <div class="permission-stat">
                <span class="stat-number" id="ask-sites">0</span>
                <span class="stat-label">Ask</span>
              </div>
            </div>
            
            <!-- Permissions List -->
            <div id="permissions-list" class="permissions-list">
              <div class="permissions-empty" id="permissions-empty">
                <div class="empty-icon">🔒</div>
                <h3>No Site Permissions</h3>
                <p>Sites you visit will appear here when they request Nostr permissions</p>
              </div>
            </div>
          </div>
        </div>
      </section>
      
      <!-- Permission Edit Dialog -->
      <dialog id="permission-edit-dialog" class="permission-dialog">
        <div class="dialog-header">
          <h2>Edit Site Permissions</h2>
          <button class="close-button" id="close-permission-dialog">×</button>
        </div>
        <div class="dialog-content">
          <div class="permission-site-info">
            <div class="site-icon" id="permission-site-icon">🌐</div>
            <div class="site-details">
              <h3 id="permission-site-name"></h3>
              <p id="permission-site-origin"></p>
            </div>
          </div>
          
          <!-- General Permissions -->
          <div class="permission-section">
            <h4>General Access</h4>
            <div class="permission-setting">
              <label>Default Policy</label>
              <select id="default-policy">
                <option value="ask">Ask each time</option>
                <option value="allow">Always allow</option>
                <option value="deny">Always deny</option>
              </select>
            </div>
          </div>
          
          <!-- Method Permissions -->
          <div class="permission-section">
            <h4>Method Permissions</h4>
            <div class="method-permissions">
              <div class="permission-method">
                <label>
                  <span class="method-name">Get Public Key</span>
                  <span class="method-description">Read your public identity</span>
                </label>
                <select data-method="getPublicKey">
                  <option value="default">Use default</option>
                  <option value="allow">Allow</option>
                  <option value="deny">Deny</option>
                  <option value="ask">Ask</option>
                </select>
              </div>
              
              <div class="permission-method">
                <label>
                  <span class="method-name">Sign Events</span>
                  <span class="method-description">Create signed messages</span>
                </label>
                <select data-method="signEvent">
                  <option value="default">Use default</option>
                  <option value="allow">Allow</option>
                  <option value="deny">Deny</option>
                  <option value="ask">Ask</option>
                </select>
              </div>
              
              <div class="permission-method">
                <label>
                  <span class="method-name">Get Relays</span>
                  <span class="method-description">Read relay configuration</span>
                </label>
                <select data-method="getRelays">
                  <option value="default">Use default</option>
                  <option value="allow">Allow</option>
                  <option value="deny">Deny</option>
                  <option value="ask">Ask</option>
                </select>
              </div>
              
              <div class="permission-method">
                <label>
                  <span class="method-name">NIP-04 Encrypt</span>
                  <span class="method-description">Encrypt private messages</span>
                </label>
                <select data-method="nip04.encrypt">
                  <option value="default">Use default</option>
                  <option value="allow">Allow</option>
                  <option value="deny">Deny</option>
                  <option value="ask">Ask</option>
                </select>
              </div>
              
              <div class="permission-method">
                <label>
                  <span class="method-name">NIP-04 Decrypt</span>
                  <span class="method-description">Decrypt private messages</span>
                </label>
                <select data-method="nip04.decrypt">
                  <option value="default">Use default</option>
                  <option value="allow">Allow</option>
                  <option value="deny">Deny</option>
                  <option value="ask">Ask</option>
                </select>
              </div>
            </div>
          </div>
          
          <!-- Event Kind Permissions -->
          <div class="permission-section">
            <h4>Event Kind Permissions</h4>
            <p class="section-description">Control which types of events this site can create</p>
            <div class="kind-permissions">
              <div class="kind-presets">
                <button class="preset-button" data-preset="social">Social Media</button>
                <button class="preset-button" data-preset="messaging">Messaging</button>
                <button class="preset-button" data-preset="custom">Custom</button>
              </div>
              <div class="kind-matrix" id="kind-matrix">
                <!-- Will be populated by JavaScript -->
              </div>
            </div>
          </div>
          
          <!-- Rate Limits -->
          <div class="permission-section">
            <h4>Rate Limits</h4>
            <div class="rate-limit-settings">
              <div class="rate-limit-setting">
                <label for="requests-per-minute">Requests per minute</label>
                <input type="number" id="requests-per-minute" min="1" max="300" value="60">
              </div>
              <div class="rate-limit-setting">
                <label for="signs-per-hour">Signs per hour</label>
                <input type="number" id="signs-per-hour" min="1" max="1000" value="20">
              </div>
            </div>
          </div>
          
          <!-- Expiration -->
          <div class="permission-section">
            <h4>Permission Expiration</h4>
            <div class="expiration-settings">
              <label>
                <input type="radio" name="expiration" value="never" checked>
                <span>Never expire</span>
              </label>
              <label>
                <input type="radio" name="expiration" value="session">
                <span>End of session</span>
              </label>
              <label>
                <input type="radio" name="expiration" value="custom">
                <span>Custom duration:</span>
              </label>
              <div class="custom-expiration" id="custom-expiration" style="display: none;">
                <input type="number" id="expiration-days" min="1" max="365" value="30">
                <span>days</span>
              </div>
            </div>
          </div>
        </div>
        <div class="dialog-footer">
          <button id="reset-permission" class="danger-button">Reset to Default</button>
          <div class="dialog-actions">
            <button id="cancel-permission-edit" class="secondary-button">Cancel</button>
            <button id="save-permission-edit" class="primary-button">Save Changes</button>
          </div>
        </div>
      </dialog>
      
      <!-- Bulk Actions Dialog -->
      <dialog id="bulk-actions-dialog" class="permission-dialog compact">
        <div class="dialog-header">
          <h3>Bulk Permission Actions</h3>
          <button class="close-button" id="close-bulk-dialog">×</button>
        </div>
        <div class="dialog-content">
          <div class="bulk-actions">
            <button class="bulk-action-button" data-action="allow-all">
              <span class="action-icon">✓</span>
              <span>Allow All Sites</span>
            </button>
            <button class="bulk-action-button" data-action="deny-all">
              <span class="action-icon">✕</span>
              <span>Deny All Sites</span>
            </button>
            <button class="bulk-action-button" data-action="reset-all">
              <span class="action-icon">↺</span>
              <span>Reset All to Ask</span>
            </button>
            <button class="bulk-action-button danger" data-action="clear-all">
              <span class="action-icon">🗑</span>
              <span>Clear All Permissions</span>
            </button>
          </div>
        </div>
      </dialog>
      
      <!-- Local Relay Section -->
      <section id="local-relay" class="settings-section" hidden>
        <h2>Local Relay</h2>
        <div class="section-content">
          <div class="setting-item">
            <label>
              <input type="checkbox" id="relay-enabled">
              <span>Enable local relay</span>
            </label>
          </div>
          
          <div class="relay-settings" id="relay-settings">
            <div class="setting-item">
              <label for="relay-port">Port:</label>
              <input type="number" id="relay-port" min="1024" max="65535">
            </div>
            
            <div class="setting-item">
              <label for="relay-interface">Interface:</label>
              <input type="text" id="relay-interface" placeholder="127.0.0.1">
            </div>
            
            <div class="setting-item">
              <label>
                <input type="checkbox" id="relay-external">
                <span>Allow external connections</span>
              </label>
            </div>
            
            <div class="setting-item">
              <label for="relay-storage">Max storage (GB):</label>
              <input type="number" id="relay-storage" min="1" max="1000">
            </div>
            
            <div class="setting-item">
              <label for="relay-events">Max events:</label>
              <input type="number" id="relay-events" min="1000" max="10000000">
            </div>
            
            <div class="setting-item">
              <label for="relay-retention">Retention days:</label>
              <input type="number" id="relay-retention" min="1" max="365">
            </div>
          </div>
        </div>
      </section>
      
      <!-- Blossom Section -->
      <section id="blossom" class="settings-section" hidden>
        <h2>Blossom Storage</h2>
        <div class="section-content">
          <div class="setting-item">
            <label>
              <input type="checkbox" id="blossom-enabled">
              <span>Enable Blossom storage</span>
            </label>
          </div>
          
          <div class="blossom-settings" id="blossom-settings">
            <div class="setting-item">
              <label for="blossom-port">Port:</label>
              <input type="number" id="blossom-port" min="1024" max="65535">
            </div>
            
            <div class="setting-item">
              <label for="blossom-storage">Max storage (GB):</label>
              <input type="number" id="blossom-storage" min="1" max="1000">
            </div>
            
            <div class="setting-item">
              <h3>Blossom Servers</h3>
              <div id="blossom-servers-list"></div>
              <button id="add-blossom-server">Add Server</button>
            </div>
          </div>
        </div>
      </section>
      
      <!-- Security Section -->
      <section id="security" class="settings-section" hidden>
        <h2>Security</h2>
        <div class="section-content">
          <div class="setting-item">
            <label>
              <input type="checkbox" id="require-password">
              <span>Require password for signing</span>
            </label>
          </div>
          
          <div class="setting-item">
            <label for="key-timeout">Key timeout (minutes):</label>
            <input type="number" id="key-timeout" min="1" max="1440">
          </div>
          
          <div class="setting-item">
            <button id="export-keys" class="secondary-button">Export Keys</button>
            <button id="backup-settings" class="secondary-button">Backup Settings</button>
          </div>
        </div>
      </section>
    </div>
  </div>
  
  <!-- Toast Notifications -->
  <div id="toast-container" class="toast-container"></div>
</body>
</html>